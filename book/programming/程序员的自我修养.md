# 程序员的自我修养——链接、装载与库

## 第七章
### 关于共享对象全局符号介入（`Global Symbol Interpose`）和符号重定义问题

共享对象全局符号介入之所以不会触发符号重定义错误，根本原因在于 `ELF` 动态链接模型的设计目标、规则以及“符号可见性”与“重定义”这两个概念在技术上的根本差异：

1. 概念区分
| 维度   | 符号重定义（redefinition）                   | 全局符号介入（interposition）               |
| ---- | ------------------------------------- | ----------------------------------- |
| 发生阶段 | **编译/链接时**                            | **运行期动态加载**                         |
| 触发条件 | 同一名称、**同一可见性**、**同一链接单元**出现两次         | **不同 DSO** 中出现同名全局符号                |
| 语言规则 | 违反 ODR（One Definition Rule）→ 报错       | ELF 规则允许 **“覆盖”** → 不报错             |
| 可见性  | *必须* 是 **STB\_GLOBAL** 且 **同版本/同可见性** | 可以是 **STB\_GLOBAL**、**STB\_WEAK** 等 |
2. `ELF` 动态链接的设计哲学
   - “共享对象（`.so`）”是**独立链接单元**：每个 `DSO, Dynamic Shared Objects` 在编译时只对自己可见，不会和别的 `DSO` 做合并符号表，因此不会触发重定义；
   - **运行时**由动态连接器（`ld.so`）把所有 `DSO` 的符号表合并为一个全局符号表，**同名符号按“最早加载者/最高优先级/最可见者”规则覆盖（interpose）**，而不是“再定义”；
3. 符号可见性级别
   `ELF` 为符号提供了可见性属性，决定了是否允许介入：
   - `STV_DEFUALT`：允许被外部覆盖；
   - `STV_PROTECTED`：禁止被外部覆盖，但可被重定位引用；
   - `STV_HIDDEN`：完全不给外部可见，自然不可能介入；
    只有当所有可见符号都是 `STV_DEFAULT` 时，才会出现“全局符号介入”，而不会触发重定义。
4. 对比静态链接和动态链接
   | 场景                | 结果                        |
| ----------------- | ------------------------- |
| 静态库 `.a` 中重复定义    | 链接器报错：multiple definition |
| 动态库 `.so` 中同名全局符号 | 运行期覆盖：符号介入生效              |

总结：**“重定义”违反的是编译/链接单元的 `ODR`，而“全局符号介入”遵循的是 `ELF` 运行期符号覆盖规则**，二者检查阶段和约束完全不同，因此不会冲突。
